<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ Speech-to-Text Test - IoT Pet Feeder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #recordBtn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        #recordBtn.recording {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            animation: pulse 1.5s infinite;
        }

        #stopBtn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .result-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .transcription {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            font-size: 16px;
            line-height: 1.6;
        }

        .command {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .command-item {
            margin: 8px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .command-item strong {
            color: #667eea;
        }

        .confidence {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .raw-json {
            background: #111827;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .confidence.high {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .confidence.medium {
            background: #fff9c4;
            color: #f57f17;
        }

        .confidence.low {
            background: #ffcdd2;
            color: #c62828;
        }

        .processing-time {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }

        .examples {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .examples h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .examples ul {
            list-style: none;
            padding-left: 0;
        }

        .examples li {
            padding: 5px 0;
            color: #666;
        }

        .examples li:before {
            content: "üí° ";
            margin-right: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Speech-to-Text Test</h1>
        <p class="subtitle">H·ªá th·ªëng IoT Cho Th√∫ C∆∞ng ƒÇn T·ª± ƒê·ªông</p>

        <div class="controls">
            <button id="recordBtn">üéôÔ∏è B·∫Øt ƒë·∫ßu ghi √¢m</button>
            <button id="stopBtn" disabled>‚èπÔ∏è D·ª´ng</button>
        </div>

        <div id="status" class="status info">
            S·∫µn s√†ng ghi √¢m. Click n√∫t "B·∫Øt ƒë·∫ßu ghi √¢m" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        </div>

        <div id="result" style="display: none;">
            <div class="result-box">
                <h3>üìù K·∫øt qu·∫£ nh·∫≠n di·ªán:</h3>
                <div id="transcription" class="transcription"></div>
                <div id="confidence" class="confidence"></div>
                <div id="processingTime" class="processing-time"></div>
            </div>

            <div class="result-box">
                <h3>üéØ L·ªánh ƒë√£ parse:</h3>
                <div id="command" class="command"></div>
            </div>

            <div class="result-box">
                <h3>üì¶ JSON tr·∫£ v·ªÅ:</h3>
                <pre id="rawResult" class="raw-json">{}</pre>
            </div>
        </div>

        <div class="examples">
            <h4>üí¨ V√≠ d·ª• l·ªánh b·∫°n c√≥ th·ªÉ th·ª≠:</h4>
            <ul>
                <li>"Cho ƒÉn" - Cho th√∫ c∆∞ng ƒÉn v·ªõi l∆∞·ª£ng m·∫∑c ƒë·ªãnh</li>
                <li>"Cho 50 gram" - Cho ƒÉn 50 gram</li>
                <li>"Cho 100g th·ª©c ƒÉn" - Cho ƒÉn 100 gram</li>
                <li>"D·ª´ng l·∫°i" - D·ª´ng qu√° tr√¨nh cho ƒÉn</li>
                <li>"Ki·ªÉm tra l∆∞·ª£ng th·ª©c ƒÉn" - Xem t√¨nh tr·∫°ng</li>
            </ul>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const transcriptionDiv = document.getElementById('transcription');
        const commandDiv = document.getElementById('command');
        const confidenceDiv = document.getElementById('confidence');
        const processingTimeDiv = document.getElementById('processingTime');
        const rawResultPre = document.getElementById('rawResult');

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Ki·ªÉm tra h·ªó tr·ª£ tr√¨nh duy·ªát
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi √¢m! Vui l√≤ng d√πng Chrome, Edge ho·∫∑c Firefox.');
        }

        // Ki·ªÉm tra k·∫øt n·ªëi server
        checkServerConnection();

        async function checkServerConnection() {
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                if (data.status === 'ok') {
                    showInfo('‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi server. L·∫ßn ch·∫°y ƒë·∫ßu c√≥ th·ªÉ m·∫•t v√†i gi√¢y ƒë·ªÉ t·∫£i Whisper.');
                }
            } catch (error) {
                showError('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. ƒê·∫£m b·∫£o backend ƒëang ch·∫°y tr√™n port 3001.');
            }
        }

        recordBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Ki·ªÉm tra h·ªó tr·ª£ MediaRecorder
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendAudioToServer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.disabled = true;
                recordBtn.classList.add('recording');
                stopBtn.disabled = false;
                showInfo('üî¥ ƒêang ghi √¢m... N√≥i l·ªánh c·ªßa b·∫°n!');

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showError('Kh√¥ng th·ªÉ truy c·∫≠p microphone! Vui l√≤ng cho ph√©p quy·ªÅn truy c·∫≠p microphone.');
            }
        });

        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.disabled = false;
                recordBtn.classList.remove('recording');
                stopBtn.disabled = true;
                showInfo('‚è≥ ƒêang x·ª≠ l√Ω audio...');
            }
        });

        async function sendAudioToServer(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('languageCode', 'vi-VN');

                showInfo('üì§ ƒêang g·ª≠i audio l√™n server...');

                const response = await fetch('http://localhost:3001/api/speech-command', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Server error');
                }

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                displayResults(data);

            } catch (error) {
                console.error('Error:', error);
                showError(`L·ªói: ${error.message}`);
                resultDiv.style.display = 'none';
                if (rawResultPre) {
                    rawResultPre.textContent = JSON.stringify({
                        success: false,
                        error: error.message,
                    }, null, 2);
                }
            }
        }

        function displayResults(data) {
            resultDiv.style.display = 'block';

            // Hi·ªÉn th·ªã transcription
            transcriptionDiv.textContent = data.transcription || 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c';
            
            // Hi·ªÉn th·ªã confidence
            if (data.confidence) {
                const confidencePercent = (data.confidence * 100).toFixed(1);
                let confidenceClass = 'low';
                if (data.confidence >= 0.8) confidenceClass = 'high';
                else if (data.confidence >= 0.5) confidenceClass = 'medium';

                confidenceDiv.textContent = `ƒê·ªô tin c·∫≠y: ${confidencePercent}%`;
                confidenceDiv.className = `confidence ${confidenceClass}`;
            } else {
                confidenceDiv.textContent = 'ƒê·ªô tin c·∫≠y: (Whisper kh√¥ng cung c·∫•p)';
                confidenceDiv.className = 'confidence medium';
            }

            // Hi·ªÉn th·ªã processing time
            if (data.processingTime) {
                processingTimeDiv.textContent = `‚è±Ô∏è Th·ªùi gian x·ª≠ l√Ω: ${data.processingTime}`;
            }

            // Hi·ªÉn th·ªã command
            if (data.command) {
                const cmd = data.command;
                let commandHTML = '';

                commandHTML += `<div class="command-item"><strong>Action:</strong> ${cmd.action}</div>`;
                
                if (cmd.amount !== null) {
                    commandHTML += `<div class="command-item"><strong>L∆∞·ª£ng:</strong> ${cmd.amount} ${cmd.unit}</div>`;
                } else {
                    commandHTML += `<div class="command-item"><strong>L∆∞·ª£ng:</strong> M·∫∑c ƒë·ªãnh</div>`;
                }

                commandHTML += `<div class="command-item"><strong>ƒê·ªô tin c·∫≠y:</strong> <span class="confidence ${cmd.confidence}">${cmd.confidence}</span></div>`;
                commandHTML += `<div class="command-item"><strong>Text g·ªëc:</strong> "${cmd.rawText}"</div>`;

                commandDiv.innerHTML = commandHTML;
            } else {
                commandDiv.innerHTML = '<div class="command-item">Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c l·ªánh.</div>';
            }

            showSuccess('‚úÖ Nh·∫≠n di·ªán th√†nh c√¥ng!');

            if (rawResultPre) {
                rawResultPre.textContent = JSON.stringify(data, null, 2);
            }
        }

        function showInfo(message) {
            statusDiv.textContent = message;
            statusDiv.className = 'status info';
        }

        function showSuccess(message) {
            statusDiv.textContent = message;
            statusDiv.className = 'status success';
        }

        function showError(message) {
            statusDiv.textContent = message;
            statusDiv.className = 'status error';
        }
    </script>
</body>
</html>

